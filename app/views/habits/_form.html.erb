<%= form_with(model: habit, local: true, class: "space-y-8") do |form| %>
  <!-- (keep your error display here if you have it) -->

  <div class="bg-white p-8 rounded-3xl shadow-xl">
    <h3 class="text-2xl font-bold mb-6 text-purple-700">Habit Details</h3>
    <div class="space-y-6">
      <div>
        <%= form.label :habit_name, class: "block text-lg font-medium text-gray-700 mb-2" %>
        <%= form.text_field :habit_name, class: "w-full px-4 py-3 rounded-xl border border-purple-200 focus:border-purple-500" %>
      </div>
      <div>
        <%= form.label :description, class: "block text-lg font-medium text-gray-700 mb-2" %>
        <%= form.text_area :description, rows: 3, class: "w-full px-4 py-3 rounded-xl border border-purple-200 focus:border-purple-500", placeholder: "Describe your habit goal..." %>
      </div>
    </div>
  </div>

  <!-- STREKLING CUSTOMIZATION -->
  <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-8 rounded-3xl shadow-xl">
    <h3 class="text-2xl font-bold mb-6 text-purple-700">Your Streakling</h3>

    <%# Nested fields for the creature %>
    <%= form.fields_for :streakling_creature, habit.streakling_creature || habit.build_streakling_creature do |creature| %>
      <div class="space-y-6">
        <div>
          <%= creature.label :streakling_name, "Streakling Name", class: "block text-lg font-medium text-gray-700 mb-2" %>
          <%= creature.text_field :streakling_name, value: creature.object.streakling_name || "Little One",
              placeholder: "Sparkles, Luna, Draco...",
              class: "w-full px-4 py-3 rounded-xl border border-purple-300 focus:border-purple-600" %>
        </div>

        <div>
          <label class="block text-lg font-medium text-gray-700 mb-4">Choose Your Companion</label>
          <div style="display: none;">Current animal_type: <%= creature.object.animal_type.inspect %></div>
          <div class="grid grid-cols-3 md:grid-cols-7 gap-4" data-animal-selector>
            <% StreaklingCreature::ANIMAL_TYPES.each do |type, data| %>
              <%= creature.radio_button :animal_type, type,
                  checked: (creature.object.animal_type || "dragon") == type.to_s,
                  class: "hidden animal-radio", id: "animal_#{type}", data: { animal_type: type } %>
              <%= label_tag "animal_#{type}", class: "cursor-pointer text-center animal-option" do %>
                <div class="bg-white rounded-2xl p-4 shadow hover:shadow-lg transition <%= (creature.object.animal_type || "dragon") == type.to_s ? 'ring-4 ring-purple-500 selected' : '' %>">
                  <div class="text-6xl"><%= data[:emoji] %></div>
                  <div class="text-sm font-medium mt-2"><%= data[:name] %></div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>

        <script>
          function initializeAnimalSelector() {
            console.log('Initializing animal selector...');
            const animalSelector = document.querySelector('[data-animal-selector]');
            if (animalSelector) {
              console.log('Found animal selector, setting up listeners...');
              const radioButtons = animalSelector.querySelectorAll('.animal-radio');
              const options = animalSelector.querySelectorAll('.animal-option > div');

              radioButtons.forEach((radio, index) => {
                radio.addEventListener('change', function() {
                  console.log('Radio button changed:', this.value);
                  // Remove selected class from all options
                  options.forEach(opt => {
                    opt.classList.remove('ring-4', 'ring-purple-500', 'selected');
                  });
                  // Add selected class to the checked option
                  if (this.checked) {
                    options[index].classList.add('ring-4', 'ring-purple-500', 'selected');
                    console.log('Added selected class to option', index);
                  }
                });
              });
            } else {
              console.log('Animal selector not found');
            }
          }

          // Initialize on page load
          document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired');
            initializeAnimalSelector();
          });
          // Also initialize on turbo events
          document.addEventListener('turbo:frame-load', function() {
            console.log('turbo:frame-load fired');
            initializeAnimalSelector();
          });
          document.addEventListener('turbo:load', function() {
            console.log('turbo:load fired');
            initializeAnimalSelector();
          });
        </script>
      </div>
    <% end %>
  </div>

  <div class="text-center">
    <%= form.submit "Save & Birth Your Streakling", class: "bg-indigo-600 hover:bg-indigo-700 text-white text-2xl px-12 py-5 rounded-full shadow-2xl font-bold" %>
  </div>
<% end %>
